<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>QR Scanner → Google Sheets</title>
  <style>
    body { font-family: sans-serif; background:#121212; color:#eee;
      display:flex; flex-direction:column; align-items:center; padding:1rem; }
    button { margin:0.5rem; padding:0.75rem 1.5rem; font-size:1rem;
      border:none; border-radius:6px; cursor:pointer; }
    #signInBtn { background:#4285F4; color:#fff; }
    #scanBtn { background:#1DB954; color:#fff; }
    video { width:100%; max-width:360px; border-radius:8px; margin-top:1rem; }
    #status { margin-top:1rem; font-size:0.9rem; }
  </style>
</head>
<body>

  <h1>QR → Sheets</h1>
  <button id="signInBtn">Sign in with Google</button>
  <button id="scanBtn" disabled>Start Scan</button>
  <div id="status">Not signed in</div>
  <video id="video" autoplay muted playsinline></video>

  <!-- ZXing for QR scanning -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <!-- Google API client -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const API_KEY      = 'AIzaSyBHvc3cTPD_27JTdBZWOlOygx9fxlSxPzs';
    const CLIENT_ID    = 'YOUR_OAUTH_CLIENT_ID.apps.googleusercontent.com';
    const SCOPES       = 'https://www.googleapis.com/auth/spreadsheets';
    const SPREADSHEET_ID = '1JNVFoli7SGCRwhC-Sn_0HzJhq7GIlWI_Hezy-RH3MC0';

    const signInBtn = document.getElementById('signInBtn');
    const scanBtn   = document.getElementById('scanBtn');
    const statusEl  = document.getElementById('status');
    const video     = document.getElementById('video');
    let qrReader;

    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        signInBtn.style.display = 'none';
        scanBtn.disabled = false;
        statusEl.textContent = 'Signed in – ready to scan';
      } else {
        signInBtn.style.display = 'inline-block';
        scanBtn.disabled = true;
        statusEl.textContent = 'Not signed in';
      }
    }

    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
        scope: SCOPES
      }).then(() => {
        const auth = gapi.auth2.getAuthInstance();
        auth.isSignedIn.listen(updateSigninStatus);
        updateSigninStatus(auth.isSignedIn.get());
        signInBtn.onclick = () => auth.signIn();
      });
    }

    gapi.load('client:auth2', initClient);

    scanBtn.addEventListener('click', () => {
      scanBtn.disabled = true;
      statusEl.textContent = 'Scanning…';
      qrReader = new ZXing.BrowserQRCodeReader();
      qrReader.decodeOnceFromVideoDevice(undefined, video)
        .then(result => {
          statusEl.textContent = 'QR: ' + result.text;
          qrReader.reset();
          appendToSheet(result.text);
        })
        .catch(err => {
          statusEl.textContent = 'Scan error: ' + err;
          scanBtn.disabled = false;
        });
    });

    function appendToSheet(qrData) {
      const params = {
        spreadsheetId: SPREADSHEET_ID,
        range: 'Sheet1',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: { values: [[ new Date().toLocaleString(), qrData ]] }
      };
      gapi.client.sheets.spreadsheets.values.append(params)
        .then(response => {
          statusEl.textContent = 'Appended ✓';
          scanBtn.disabled = false;
        }, err => {
          statusEl.textContent = 'Append error: ' + err.result.error.message;
          scanBtn.disabled = false;
        });
    }
  </script>
</body>
</html>
